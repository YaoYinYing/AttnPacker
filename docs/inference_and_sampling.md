# Inference and Sampling Guide

AttnPacker provides tools for predicting and refining protein side-chain
configurations as well as sampling alternative sequences.  This guide walks
through the main workflows for running inference on structures and sampling
new residues.

## Inference

### Post-processing a PDB

The simplest entry point is :func:`project_pdb`, which projects side-chain
atoms onto a continuous rotamer library and optimizes steric clashes.  The
function accepts an input PDB file and writes an updated structure to disk:

```python
from AttenPacker import project_pdb
project_pdb("examples/T0967.pdb", pdb_path_out="processed.pdb")
```

A command line interface exposes the same behavior via the
``attnpacker-post-process`` script:

```bash
attnpacker-post-process path/to/input.pdb --pdb_path_out path/to/out.pdb
```

### Full model inference

To generate predictions with the neural network, use :class:`InferenceRunner`.
It wraps the :class:`~AttenPacker.models.inference_utils.Inference` helper and
writes the predicted PDB to disk:

```python
from AttenPacker import InferenceRunner

runner = InferenceRunner(resource_root="/path/to/resources", save_dir="outputs")
runner.run("examples/T0967.pdb")            # single file
runner.run_batch(["a.pdb", "b.pdb"])      # multiple files

# optionally project onto discrete rotamers for clash removal
runner.run("examples/T0967.pdb", postprocess=True)
```

The runner accepts optional ``seq_mask`` and ``dihedral_mask`` tensors to
design selected residues or condition on rotamers.  Large proteins can be
split into overlapping crops by adjusting ``chunk_size`` when constructing the
object.

## Sampling

The :class:`SamplingRunner` automates sequence design by sampling amino acids
from the model's logits at a specified temperature:

```python
from AttenPacker import SamplingRunner

sampler = SamplingRunner(resource_root="/path/to/resources")
sequences = sampler.sample("examples/T0967.pdb", n_samples=5, temperature=0.2)

# return FASTA-formatted strings describing each design
fastas = sampler.sample(
    "examples/T0967.pdb", n_samples=2, return_fasta=True
)
```

Mask tensors can be supplied via ``seq_mask`` and ``dihedral_mask`` to restrict
sampling to particular residues or to enable rotamer conditioning.

For convenience, :mod:`AttenPacker.util` provides helpers such as
``residue_mask`` for constructing boolean masks, ``sample_sequence`` for
drawing sequences from logits, ``score_sequence`` for evaluating designs and
``to_fasta_entry`` for formatting FASTA outputs.

## Output post-processing

The predictions from either inference pathway can be further refined with
``project_pdb`` to minimize steric clashes and write a final PDB file.
``project_pdb`` accepts the same arguments shown earlier and can operate on
outputs generated by the neural network.

## Further reading

- ``src/AttenPacker/inference_runner.py`` provides the implementation of
  the batch inference wrapper.
- ``src/AttenPacker/models/inference_utils.py`` contains the higher level
  ``Inference`` class and utilities for handling long sequences.
- ``src/AttenPacker/models/model_abc/structure_model.py`` documents the
  ``sample`` method used for sequence design.

